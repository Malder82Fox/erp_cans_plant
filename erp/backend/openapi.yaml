openapi: 3.0.3
info:
  title: ERP Platform API
  version: 1.0.0
servers:
  - url: http://localhost:8000
paths:
  /api/v1/auth/login:
    post:
      tags: [Auth]
      summary: Authenticate user
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                username:
                  type: string
                password:
                  type: string
              required: [username, password]
      responses:
        '200':
          description: Token pair
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenPair'
  /api/v1/auth/refresh:
    post:
      tags: [Auth]
      summary: Refresh tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                refresh_token:
                  type: string
              required: [refresh_token]
      responses:
        '200':
          description: Token pair
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenPair'
  /api/v1/auth/logout:
    post:
      tags: [Auth]
      summary: Logout current user
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Logged out
  /api/v1/auth/users/me:
    get:
      tags: [Auth]
      summary: Get current user profile
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserRead'
  /api/v1/warehouse/parts:
    get:
      tags: [Warehouse]
      summary: List parts with filters
      parameters:
        - in: query
          name: q
          schema:
            type: string
        - in: query
          name: category_id
          schema:
            type: integer
        - in: query
          name: page
          schema:
            type: integer
        - in: query
          name: page_size
          schema:
            type: integer
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Paginated parts
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Part'
                  total:
                    type: integer
                  page:
                    type: integer
                  page_size:
                    type: integer
    post:
      tags: [Warehouse]
      summary: Create part
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PartCreate'
      responses:
        '200':
          description: Created part
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Part'
  /api/v1/warehouse/parts/import:
    post:
      tags: [Warehouse]
      summary: Import parts from CSV/XLSX (add-only)
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: mapping
          required: true
          schema:
            type: string
          description: JSON mapping of source columns to fields
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                upload:
                  type: string
                  format: binary
      responses:
        '200':
          description: Import summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImportResult'
  /api/v1/maintenance/pm/generate-due:
    post:
      tags: [Maintenance]
      summary: Generate due PM work orders
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Summary of generated work orders
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerateDueResponse'
  /api/v1/maintenance/work-orders/{work_order_id}:
    put:
      tags: [Maintenance]
      summary: Update work order status
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: work_order_id
          schema:
            type: integer
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkOrderUpdate'
      responses:
        '200':
          description: Updated work order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkOrder'
  /api/v1/tooling/batches/{batch_id}/operation:
    post:
      tags: [Tooling]
      summary: Execute batch operation
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: batch_id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchOperationPayload'
      responses:
        '200':
          description: Operation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchOperationResult'
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    TokenPair:
      type: object
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        token_type:
          type: string
      required: [access_token, refresh_token, token_type]
    UserRead:
      type: object
      properties:
        id:
          type: integer
        username:
          type: string
        full_name:
          type: string
        email:
          type: string
        role:
          type: string
    Part:
      type: object
      properties:
        id:
          type: integer
        part_code:
          type: string
        name:
          type: string
        qty_on_hand:
          type: number
        min_stock:
          type: number
        price:
          type: number
        currency:
          type: string
    PartCreate:
      type: object
      properties:
        part_code:
          type: string
        name:
          type: string
        qty_on_hand:
          type: number
        min_stock:
          type: number
        price:
          type: number
        currency:
          type: string
      required: [part_code, name]
    ImportResult:
      type: object
      properties:
        created:
          type: integer
        skipped:
          type: integer
        errors:
          type: integer
    GenerateDueResponse:
      type: object
      properties:
        created_work_orders:
          type: integer
    WorkOrderUpdate:
      type: object
      properties:
        status:
          type: string
        summary:
          type: string
        downtime_min:
          type: number
    WorkOrder:
      type: object
      properties:
        id:
          type: integer
        status:
          type: string
        summary:
          type: string
        downtime_min:
          type: number
    BatchOperationPayload:
      type: object
      properties:
        op_type:
          type: string
          enum: [inspection, cleaning, grinding]
        apply_to_all:
          type: boolean
        changes:
          type: array
          items:
            type: object
            properties:
              tool_id:
                type: integer
              changes:
                type: array
                items:
                  type: object
                  properties:
                    dim_name:
                      type: string
                    new_value:
                      type: number
      required: [op_type, changes]
    BatchOperationResult:
      type: object
      properties:
        processed:
          type: integer
        skipped:
          type: integer
